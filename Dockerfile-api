FROM mcr.microsoft.com/dotnet/core/sdk:3.1.100-buster AS builder

# Set the working directory
WORKDIR /build

# Create directories for all project files
RUN mkdir -p ./WordFlip.Domain ./WordFlip.Infrastructure ./WordFlip.Services ./WordFlip.WebApi

# Copy the the project files
COPY ./src/WordFlip.Domain/WordFlip.Domain.csproj ./WordFlip.Domain
COPY ./src/WordFlip.Infrastructure/WordFlip.Infrastructure.csproj ./WordFlip.Infrastructure
COPY ./src/WordFlip.Services/WordFlip.Services.csproj ./WordFlip.Services
COPY ./src/WordFlip.WebApi/WordFlip.WebApi.csproj ./WordFlip.WebApi

# Restore the dependencies of the project
RUN dotnet restore ./WordFlip.WebApi/WordFlip.WebApi.csproj

# Copy the rest of the source files
COPY ./src ./

ARG APPSETTINGS=Docker

# Rename the Docker-specific API settings file to its default name
RUN mv ./WordFlip.WebApi/appsettings.${APPSETTINGS}.json ./WordFlip.WebApi/appsettings.json

# Build and deploy the application
RUN dotnet publish ./WordFlip.WebApi/WordFlip.WebApi.csproj -c Release -p:PublishDir=publish



FROM mcr.microsoft.com/dotnet/core/aspnet:3.1.0-buster-slim

WORKDIR /app
COPY --from=builder /build/WordFlip.WebApi/publish .

ENV ASPNETCORE_URLS=http://+:8080

ARG ENV=Production
ENV ASPNETCORE_ENVIRONMENT=${ENV}
EXPOSE 8080

# Start the web API service
ENTRYPOINT ["dotnet", "./WordFlip.WebApi.dll"]